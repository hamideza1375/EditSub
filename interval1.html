<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body dir="rtl" style="display: flex;flex-direction: column;">
    <form onsubmit="sendFile(event)">
        <input accept="video/*" type="file" />
        <input type="submit" />
        <div style="display: flex;flex-direction: row; justify-content: center;">
            <h2 onclick="_stop()" style="margin: 0 15px; cursor: pointer;">⏸</h2>
            <h2 onclick="_play()" style="margin: 5px 15px 0; cursor: pointer;">▶</h2>
        </div>
    </form>

    <video style="margin-right: 20px; width: calc(100% - 70px); height: calc(100% - 175px);" muted
        aria-readonly="false">
        <source type="video/mp4" />
    </video>
    <div id="divScroll" style="height: 100px; width: 360px; margin: 5px auto 0;">
        <p id="p"
            style="font-size: 17px; line-height: 2; font-weight: 600;font-family: monospace, sans-serif; padding: 10px; text-align: justify;">
        </p>
    </div>
    <audio style="display: flex; align-self: center; " autoplay>
        <source type="audio/wav">
    </audio>
</body>
<script src="./public/axios.js"></script>
<script>

    let count = 20, int, int2, int3, audio1, audio2, playCount = 0, text1, text2, started, s = 30

    function _play() { document.getElementById('p').innerHTML && document.querySelector('video').play() }
    function _stop() { document.getElementById('p').innerHTML && document.querySelector('video').pause() }

    async function sendFile(event) {
        event.preventDefault();
        document.getElementById('p').innerHTML = ''
        int && clearInterval(int)
        int2 && clearInterval(int2)
        int3 && clearInterval(int3)
        var fileURL = URL.createObjectURL(document.querySelector('input').files[0]);
        const video = document.querySelector('video')
        const audio = document.querySelector('audio')
        video.src = fileURL
        started = false
        video.ondurationchange = async function () {
            if (!started) {
                started = true
                const duration = video.duration
                video.pause()
                const fData = new FormData();
                fData.append('video', document.querySelector('input').files[0]);
                fData.append('duration', duration);
                const { status, data } = await axios.post('http://localhost:4000/upload', fData, { headers: { "Content-Type": "multipart/form-data", } })
                if (status === 200) {
                    document.getElementById('p').innerHTML = data.text
                    text1 = data.text
                    video.play()
                    document.getElementById('divScroll').scrollTo(0, 0)
                    count = 0
                    audio.src = "http://localhost:4000/" + data.audioUrl
                    audio1 = "http://localhost:4000/" + data.audioUrl

                    int2 = setTimeout(() => {
                        audio.src = "http://localhost:4000/" + data.audioUrl + '.' + s + '.wav'
                        var url = "http://localhost:4000/" + data.audioUrl + '.' + s + '.txt'
                        var jsonFile = new XMLHttpRequest();
                        jsonFile.open("GET", url, true);
                        jsonFile.send();
                        jsonFile.onreadystatechange = function () {if (jsonFile.readyState == 4 && jsonFile.status == 200) document.getElementById('p').innerHTML = jsonFile.responseText; document.getElementById('divScroll').scrollTo(0, 0); count = 0}
                        s += 30
                        if (s >= video.duration) clearInterval(int2)
                    }, 35000);

                }
            }
        }
    }

    document.getElementById('divScroll').onscroll = () => {
        count = document.getElementById('divScroll').scrollTop
        count += 20
    }

    document.querySelector('video').onplay = () => {
        document.getElementById('divScroll').style.overflowY = 'scroll'

        playCount += 1
        if ((document.querySelector('audio').currentTime < document.querySelector('audio').duration) || (document.querySelector('video').duration == document.querySelector('video').currentTime || document.querySelector('video').currentTime < 2))
            document.querySelector('audio').play()
        count = document.getElementById('divScroll').scrollTop
        setTimeout(() => { count += 1 }, 2000);
        int = setInterval(() => {
            document.getElementById('divScroll').scrollTo(0, count)
            if (count >= document.getElementById('divScroll').scrollHeight) { clearInterval(int) }
        }, 2420);
    }

    document.querySelector('video').onpause = () => {
        !document.querySelector('video').ended && document.querySelector('audio').pause();
        if (document.querySelector('video').ended) setTimeout(() => { if (int) clearInterval(int) }, 10000)
        else if (int) clearInterval(int)
    }

</script>

</html>