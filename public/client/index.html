<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body dir="rtl" style="display: flex;flex-direction: column;">
    <form style="display: flex;flex-direction: row; justify-content: center;" onsubmit="sendFile(event)">
        <div style="display: flex;flex-direction: row; justify-content: center;  height: 30px;">
            <div style="border: 1px solid black; width: 150px; display: flex; align-items: center;">
                <p style="position: absolute; margin-right: 7px;font-size: 13px;">انتخاب از گالری</p>
                <input style="opacity: 0; height: 100%; width: 100%;" accept="video/*" type="file" />
            </div>

            <input type="submit" value="ارسال" />
        </div>

        <div style="display: flex;flex-direction: row; justify-content: center; margin-right: 50px;">
            <h2 onclick="_stop()" style="margin: 0 15px; cursor: pointer;">⏸</h2>
            <h2 onclick="_play()"
                style="margin: 4px 15px 0; cursor: pointer; background-color: rgb(69, 108, 238); height: 26px; width: 23px; border: 1px solid black; padding-right: 1px;">
                ▶</h2>
        </div>
    </form>

    <div id="part" dir="ltr"
        style="justify-content: center;margin-right: 10px; width: calc(100% - 20px);height: 40px;border: 1px solid black;display: flex;flex-direction: row;">

    </div>

    <video
        style="margin-right: 10px; width: calc(100% - 20px); height: calc(100% - 175px); object-fit: fill; resize: vertical;"
        muted aria-readonly="false">
        <source type="video/mp4" />
    </video>
    <div id="divScroll" style="height: 110px; width: 360px; margin: 5px auto 0;">
        <p id="p"
            style="font-size: 16.5px; line-height: 1.9; font-weight: 600;font-family: monospace, sans-serif; padding: 10px; text-align: justify;">
        </p>
    </div>
    <audio style="display: flex; align-self: center; " autoplay>
        <source type="audio/wav">
    </audio>
</body>
<script src="./client/axios.js"></script>
<script>


    let arr = [60, 120, 180, 240, 300, 360, 420, 480, 540, 600, 660, 720, 780, 840, 900]
    const localhost = 'http://localhost:4000'
    // const localhost = 'http://192.168.247.240:4000'




    let count = 20, int, int2, int3, audio1, audio2, playCount = 0, text1, text2, started, s = 0, s2 = 0, a

    function _play() { document.getElementById('p').innerHTML && document.querySelector('video').play() }
    // function _stop() { console.log(document.querySelector('video').duration / 60); }
    // function _stop() { document.querySelector('video').currentTime = 1 * 60 }
    function _stop() { document.getElementById('p').innerHTML && document.querySelector('video').pause() }

    async function sendFile(event) {
        event.preventDefault();
        document.getElementById('p').innerHTML = ''
        int && clearInterval(int)
        int2 && clearInterval(int2)
        int3 && clearInterval(int3)
        var fileURL = URL.createObjectURL(document.querySelector('input').files[0]);
        const video = document.querySelector('video')
        const audio = document.querySelector('audio')
        video.src = fileURL
        started = false




        video.ondurationchange = async function () {

            const videoPart = document.querySelector('video').duration / 60
            for (let i = 0; i <= videoPart; i++) {
                const div = document.createElement("div");
                const para = document.createElement("p");
                para.innerText = i;
                para.style.display = 'flex';
                para.style.margin = 'auto auto';
                div.style.display = 'flex';
                div.style.flex = 1;
                div.style.opacity = .4;
                div.id = String(i);
                div.style.border = '1px solid black';
                div.onclick = () => {
                    if(document.getElementById('p').innerHTML){
                    document.querySelector('video').currentTime = (i)
                    if (i === 0) {
                        document.getElementById('divScroll').scrollTo(0, 0)
                        count = 0
                        setTimeout(() => { document.getElementById('divScroll').scrollTo(0, 2); count = 2 }, 2500);
                        if (audio1) document.querySelector('audio').src = `${localhost}/upload/` + audio1
                        document.getElementById('p').innerHTML = text1
                    }
                    else {
                        var jsonFile = new XMLHttpRequest();
                        jsonFile.open("GET", `${localhost}/upload/` + audio1 + '.' + (i * 60) + '.txt', true);
                        jsonFile.send();
                        if(jsonFile.status != 404){
                        setTimeout(() => { document.getElementById('divScroll').scrollTo(0, 2); count = 2 }, 2500);
                        document.querySelector('audio').src = `${localhost}/upload/` + audio1 + '.' + (i * 60) + '.wav'
                        jsonFile.onreadystatechange = function () { if (jsonFile.readyState == 4 && jsonFile.status == 200) document.getElementById('p').innerHTML = jsonFile.responseText; document.getElementById('divScroll').scrollTo(0, 0); count = 0 }
                  }
                    }
}
                };
                div.appendChild(para)
                document.getElementById('part').appendChild(div)
            }


            if (!started) {
                started = true
                const duration = video.duration
                video.pause()
                const fData = new FormData();
                fData.append('video', document.querySelector('input').files[0]);
                fData.append('duration', duration);
                const { status, data } = await axios.post(`${localhost}/upload`, fData, { headers: { "Content-Type": "multipart/form-data", } })
                if (status === 200) {
                    document.getElementById('p').innerHTML = data.text
                    text1 = data.text
                    video.play()
                    document.getElementById('divScroll').scrollTo(0, 0)
                    count = 0
                    audio.src = `${localhost}/upload/` + data.audioUrl
                    audio1 = data.audioUrl
                    int2 = setInterval(() => {
                        for (let i in arr) {
                            if (video.currentTime >= arr[i] && video.currentTime < (arr[i] + 60) && s < arr[i]) {
                                a = arr[i]
                                var http = new XMLHttpRequest();
                                http.open('HEAD', `${localhost}/upload/` + data.audioUrl + '.' + a + '.wav', false);
                                http.send();
                                if (http.status != 404) {
                                    s = arr[i]
                                    audio.src = `${localhost}/upload/` + data.audioUrl + '.' + a + '.wav'
                                    var url = `${localhost}/upload/` + data.audioUrl + '.' + a + '.txt'
                                    var jsonFile = new XMLHttpRequest();
                                    jsonFile.open("GET", url, true);
                                    jsonFile.send();
                                    jsonFile.onreadystatechange = function () { if (jsonFile.readyState == 4 && jsonFile.status == 200) document.getElementById('p').innerHTML = jsonFile.responseText; document.getElementById('divScroll').scrollTo(0, 0); count = 0 }
                                    if (s >= video.duration) clearInterval(int2)
                                }
                            }
                        }
                    }, 3000);
                }
            }
        }
    }

    document.getElementById('divScroll').onscroll = () => {
        count = document.getElementById('divScroll').scrollTop
        count += 20
    }

    document.querySelector('video').onplay = () => {
        document.getElementById('divScroll').style.overflowY = 'scroll'
        const video = document.querySelector('video').duration
        if (document.querySelector('video').currentTime < 1 && playCount > 0) {
            int2 && clearInterval(int2)
            int3 && clearInterval(int3)
            document.getElementById('divScroll').scrollTo(0, 0)
            count = 0
            setTimeout(() => { document.getElementById('divScroll').scrollTo(0, 2); count = 2 }, 2500);
            if (audio1) document.querySelector('audio').src = `${localhost}/upload/` + audio1
            document.getElementById('p').innerHTML = text1

            int3 = setInterval(() => {
                for (let i in arr) {
                    if ((document.querySelector('video').currentTime >= arr[i] && document.querySelector('video').currentTime < (arr[i] + 60) && s2 < arr[i]) || (document.querySelector('video').currentTime >= arr[i] && document.querySelector('video').currentTime < (arr[i] + 3))) {
                        console.log('aaaa', arr[i]);
                        s2 = arr[i]
                        document.querySelector('audio').src = `${localhost}/upload/` + audio1 + '.' + arr[i] + '.wav'
                        var url = `${localhost}/upload/` + audio1 + '.' + arr[i] + '.txt'
                        var jsonFile = new XMLHttpRequest();
                        jsonFile.open("GET", url, true);
                        jsonFile.send();
                        if(jsonFile.status != 404){
                        jsonFile.onreadystatechange = function () { if (jsonFile.readyState == 4 && jsonFile.status == 200) document.getElementById('p').innerHTML = jsonFile.responseText; document.getElementById('divScroll').scrollTo(0, 0); count = 0 }
                        if (s2 >= video) clearInterval(int3)
                    }
                    }
                }
            }, 3000);

        }

        playCount += 1
        if ((document.querySelector('audio').currentTime < document.querySelector('audio').duration) || (document.querySelector('video').duration == document.querySelector('video').currentTime || document.querySelector('video').currentTime < 2))
            document.querySelector('audio').play()
        count = document.getElementById('divScroll').scrollTop
        setTimeout(() => { count += 1 }, 2000);
        int = setInterval(() => {
            document.getElementById('divScroll').scrollTo(0, count)
            if (count >= document.getElementById('divScroll').scrollHeight) { clearInterval(int) }
        }, 2500);
    }

    document.querySelector('video').onpause = () => {
        !document.querySelector('video').ended && document.querySelector('audio').pause();
        if (document.querySelector('video').ended) setTimeout(() => { if (int) clearInterval(int) }, 10000)
        else if (int) clearInterval(int)
    }

</script>

</html>