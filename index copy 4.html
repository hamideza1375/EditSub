<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body dir="rtl" style="display: flex;flex-direction: column;">
    <form onsubmit="sendFile(event)">
        <input accept="video/*" type="file" />
        <input type="submit" />
        <div style="display: flex;flex-direction: row; justify-content: center;">
            <h2 onclick="_stop()" style="margin: 0 15px; cursor: pointer;">⏸</h2>
            <h2 onclick="_play()" style="margin: 5px 15px 0; cursor: pointer;">▶</h2>
        </div>
    </form>

    <video style="margin-right: 20px; width: calc(100% - 70px); height: calc(100% - 175px);" muted
        aria-readonly="false">
        <source type="video/mp4" />
    </video>
    <div id="divScroll" style="height: 100px; width: 360px; margin: 5px auto 0;">
        <p id="p"
            style="font-size: 17px; line-height: 2; font-weight: 600;font-family: monospace, sans-serif; padding: 10px; text-align: justify;">
        </p>
    </div>
    <audio style="display: flex; align-self: center; " autoplay>
        <source type="audio/wav">
    </audio>
</body>
<script src="./public/axios.js"></script>
<script>

    let count = 20, int, int2, int3, audio1, audio2, playCount = 0, text1, text2, started

    function _play() { document.getElementById('p').innerHTML && document.querySelector('video').play() }
    function _stop() { document.getElementById('p').innerHTML && document.querySelector('video').pause() }

    async function sendFile(event) {
        event.preventDefault();
        document.getElementById('p').innerHTML = ''
        int && clearInterval(int)
        int2 && clearInterval(int2)
        int3 && clearInterval(int3)
        var fileURL = URL.createObjectURL(document.querySelector('input').files[0]);
        const video = document.querySelector('video')
        const audio = document.querySelector('audio')
        video.src = fileURL
        started = false
        video.ondurationchange = async function () {
            if (!started) {
                started = true
                const duration = video.duration
                video.pause()
                const fData = new FormData();
                fData.append('video', document.querySelector('input').files[0]);
                fData.append('duration', duration);
                const { status, data } = await axios.post('http://localhost:4000/upload', fData, { headers: { "Content-Type": "multipart/form-data", } })
                if (status === 200) {
                    document.getElementById('p').innerHTML = data.text
                    text1 = data.text
                    video.play()
                    document.getElementById('divScroll').scrollTo(0, 0)
                    count = 0
                    audio.src = "http://localhost:4000/" + data.audioUrl
                    audio1 = "http://localhost:4000/" + data.audioUrl

                    const { status: status2, data: data2 } = await axios.post('http://localhost:4000/upload2', { fileName: data.videoUrl, part1: data.part1, part2: data.part2 }, { headers: { "Content-Type": "application/json", } })
                    if (status2 === 200) {
                        int2 = setInterval(async () => {
                            if (((video.currentTime + .5 >= document.querySelector('audio').duration)) && (video.currentTime + .5 >= ((video.duration / 2)))) {
                                document.getElementById('p').innerHTML = document.getElementById('p').innerHTML + '\n' + data2.text
                                text2 = data2.text
                                count += 10
                                video.play()
                                audio.src = "http://localhost:4000/" + data2.audioUrl
                                audio2 = "http://localhost:4000/" + data2.audioUrl
                                clearInterval(int2)
                            }
                        }, 1500);
                    }
                }
            }
        }
    }

    document.getElementById('divScroll').onscroll = () => {
        count = document.getElementById('divScroll').scrollTop
        count += 20
    }

    document.querySelector('video').onplay = () => {
        document.getElementById('divScroll').style.overflowY = 'scroll'
        if (document.querySelector('video').currentTime < 1 && playCount > 0) {
            int2 && clearInterval(int2)
            int3 && clearInterval(int3)
            document.getElementById('divScroll').scrollTo(0, 0)
            count = 0
            setTimeout(() => {
                document.getElementById('divScroll').scrollTo(0, 0)
                count = 0
            }, 2500);
            if (audio1) document.querySelector('audio').src = audio1
            document.getElementById('p').innerHTML = text1
            int3 = setInterval(async () => {
                if ((document.querySelector('video').currentTime >= ((document.querySelector('video').duration / 2)))) {
                    if (audio2) document.querySelector('audio').src = audio2
                    document.getElementById('p').innerHTML = text2
                    document.getElementById('divScroll').scrollTo(0, 0)
                    count = 0
                    clearInterval(int3)
                }
            }, 1500);
        }
        playCount += 1
        if ((document.querySelector('audio').currentTime < document.querySelector('audio').duration) || (document.querySelector('video').duration == document.querySelector('video').currentTime || document.querySelector('video').currentTime < 2))
            document.querySelector('audio').play()
        count = document.getElementById('divScroll').scrollTop
        setTimeout(() => { count += 1 }, 2000);
        int = setInterval(() => {
            document.getElementById('divScroll').scrollTo(0, count)
            if (count >= document.getElementById('divScroll').scrollHeight) { clearInterval(int) }
        }, 2420);
    }

    document.querySelector('video').onpause = () => {
        !document.querySelector('video').ended && document.querySelector('audio').pause();
        if (document.querySelector('video').ended) setTimeout(() => { if (int) clearInterval(int) }, 10000)
        else if (int) clearInterval(int)
    }

</script>

</html>