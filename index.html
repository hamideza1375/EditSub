<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body style="display: flex;flex-direction: column;">
    <form onsubmit="sendFile(event)">
        <input accept="video/*" type="file" />
        <input type="submit" />
        <div style="display: flex;flex-direction: row; justify-content: center;">
            <h2 onclick="_stop()" style="margin: 0 15px; cursor: pointer;">⏸</h2>
            <h2 onclick="_play()" style="margin: 5px 15px 0; cursor: pointer;">▶</h2>
        </div>
    </form>

    <video style="margin-left: 20px; width: calc(100% - 70px); height: calc(100% - 175px);" muted>
        <source type="video/mp4" />
    </video>
    <div id="divScroll" style="height: 100px; width: 360px; margin: 0 auto;">
        <p id="p" style="font-size: 16px; line-height: 2; font-weight: 600; padding: 10px; text-align: justify;"></p>
    </div>
    <audio style="display: flex; align-self: center; " autoplay>
        <source type="audio/wav">
    </audio>
</body>
<script src="./public/axios.js"></script>
<script>

    function _play() { document.querySelector('video').play() }
    function _stop() { document.querySelector('video').pause() }

    let count = 20, int, int2
    async function sendFile(event) {
        event.preventDefault();
        document.getElementById('p').innerHTML = ''
        int && clearInterval(int)
        int2 && clearInterval(int2)
        var fileURL = URL.createObjectURL(document.querySelector('input').files[0]);
        const video = document.querySelector('video')
        const audio = document.querySelector('audio')
        video.src = fileURL
        video.ondurationchange = async function () {
            const duration = video.duration
            video.pause()
            const fData = new FormData();
            fData.append('video', document.querySelector('input').files[0]);
            fData.append('duration', duration);
            const { status, data } = await axios.post('http://localhost:4000/upload', fData, { headers: { "Content-Type": "multipart/form-data", } })
            if (status === 200) {
                console.log('end', 'end');

                document.getElementById('p').innerHTML = data.text
                video.play()
                document.getElementById('divScroll').scrollTo(0, 0)
                count = 0
                audio.src = "http://localhost:4000/" + data.audioUrl

                const { status: status2, data: data2 } = await axios.post('http://localhost:4000/upload2', { fileName: data.videoUrl, part1: data.part1, part2: data.part2 }, { headers: { "Content-Type": "application/json", } })
                if (status2 === 200) {
                    console.log('end2', 'end2');

                    int2 = setInterval(async () => {
                        if (((video.currentTime >= document.querySelector('audio').duration)) && (video.currentTime >= ((video.duration / 3)))) {
                            document.getElementById('p').innerHTML = data2.text
                            video.play()
                            document.getElementById('divScroll').scrollTo(0, 0)
                            count = 0
                            setTimeout(() => {
                                document.getElementById('divScroll').scrollTo(0, 0)
                                count = 0
                            }, 3000);
                            audio.src = "http://localhost:4000/" + data2.audioUrl
                            clearInterval(int2)
                        }
                    }, 1500);
                }

            }
        }
    }

    document.getElementById('divScroll').onscroll = () => {
        count = document.getElementById('divScroll').scrollTop
        count += 20
    }

    document.querySelector('video').onplay = () => {
        document.querySelector('audio').play()
        document.getElementById('divScroll').style.overflowY = 'scroll'
        count = document.getElementById('divScroll').scrollTop
        count += 5
        int = setInterval(() => {
            document.getElementById('divScroll').scrollTo(0, count)
            if (count >= document.getElementById('divScroll').scrollHeight) { clearInterval(int) }
        }, 3100);
    }

    document.querySelector('video').onpause = () => { !document.querySelector('video').ended && document.querySelector('audio').pause(); if (int && (count + 20) >= document.getElementById('divScroll').scrollHeight) clearInterval(int) }

</script>

</html>